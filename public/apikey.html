<!DOCTYPE html>
<html lang="en" class="bg-black text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your API Key | MXAPI</title>
  <script>
    const token = localStorage.getItem('mxapi_token');
    const userId = localStorage.getItem('mxapi_id');
    if (!token || !userId) window.location.href = 'index.html';
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-6 flex flex-col items-center justify-center min-h-screen">
  <div class="bg-gray-900 p-6 rounded-2xl shadow-xl w-full max-w-md text-center space-y-4">
    <h2 class="text-2xl font-bold mb-4">ğŸ”‘ Your API Key</h2>
    <p class="text-sm text-gray-400">Use this key to access protected MXAPI routes. Keep it safe!</p>

    <div id="keyBox" class="bg-gray-800 px-4 py-3 rounded flex items-center justify-between w-full hidden">
      <div class="flex-1 overflow-auto">
        <span id="apiKey" class="tracking-widest font-mono text-sm break-all block text-left pr-2">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
      </div>
      <button onclick="toggleKey()" class="ml-2 text-xl" id="eyeBtn">ğŸ‘ï¸</button>
      <button onclick="copyKey()" class="ml-2 text-xl" title="Copy Key">ğŸ“‹</button>
      <button onclick="regenerateKey()" class="ml-2 text-xl" title="Regenerate Key" id="regenBtn">ğŸ”</button>
    </div>

    <p id="noKey" class="text-red-500 text-sm hidden">âš ï¸ No API Key found. Please login again.</p>
    <p id="regenInfo" class="text-xs text-gray-400 hidden"></p>
  </div>

  <script>
    let showing = false;
    let savedKey = '';
    let remaining = 3;

    window.onload = async function () {
      savedKey = localStorage.getItem('mxapi_apikey');
      const box = document.getElementById('keyBox');
      const noKey = document.getElementById('noKey');
      const info = document.getElementById('regenInfo');

      if (savedKey) {
        document.getElementById('apiKey').textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
        box.classList.remove('hidden');
        // Optional: get remaining regen count from backend
        try {
          const res = await fetch('https://mxgamecoder-klfx.onrender.com/api/user/get-api-key', {
            headers: { 'Authorization': `Bearer ${localStorage.getItem("mxapi_token")}` }
          });
          const data = await res.json();
          if (data.remaining !== undefined) {
            remaining = data.remaining;
            info.textContent = `ğŸ” You have ${remaining} regeneration(s) left.`;
            info.classList.remove('hidden');
            if (remaining <= 0) {
              document.getElementById('regenBtn').disabled = true;
              document.getElementById('regenBtn').classList.add('opacity-40', 'cursor-not-allowed');
            }
          }
        } catch {}
      } else {
        noKey.classList.remove('hidden');
      }
    };

    function toggleKey() {
      const keySpan = document.getElementById('apiKey');
      showing = !showing;
      keySpan.textContent = showing ? savedKey : 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
      document.getElementById('eyeBtn').textContent = showing ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
    }

    function copyKey() {
      if (!savedKey) return;
      navigator.clipboard.writeText(savedKey).then(() => {
        alert("ğŸ“‹ API Key copied to clipboard");
      });
    }

    async function regenerateKey() {
      if (remaining <= 0) return;

      const confirmRegenerate = confirm("Are you sure you want to regenerate your API key? It will replace your old one.");
      if (!confirmRegenerate) return;

      try {
        const res = await fetch('/api/user/create-api-key', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${localStorage.getItem("mxapi_token")}` }
        });

        const data = await res.json();
        if (data.apiKey) {
          savedKey = data.apiKey;
          localStorage.setItem('mxapi_apikey', savedKey);
          document.getElementById('apiKey').textContent = showing ? savedKey : 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';

          if (data.remaining !== undefined) {
            remaining = data.remaining;
            document.getElementById('regenInfo').textContent = `ğŸ” You have ${remaining} regeneration(s) left.`;
            if (remaining <= 0) {
              document.getElementById('regenBtn').disabled = true;
              document.getElementById('regenBtn').classList.add('opacity-40', 'cursor-not-allowed');
            }
          }

          alert("âœ… API key regenerated successfully.");
        } else {
          alert(data.msg || "âŒ Could not regenerate key.");
        }
      } catch (e) {
        console.error(e);
        alert("âŒ Error occurred while regenerating key.");
      }
    }
  </script>
</body>
</html>
