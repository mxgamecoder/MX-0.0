<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🧠 MSWORLD API Explorer 2025</title>
  <script>
    const token = localStorage.getItem('mxapi_token');
    const id = localStorage.getItem('mxapi_id');
    if (!token || !id) {
      window.location.href = "index.html";
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#121212] text-white font-sans p-4 min-h-screen">

  <h1 class="text-3xl font-bold text-center mb-4">⚡ MSWORLD API Explorer</h1>

  <div class="flex justify-center mb-6">
    <input
      id="searchInput"
      type="text"
      placeholder="🔍 Search for an API..."
      class="w-full max-w-xl px-4 py-3 rounded-lg bg-[#1e1e1e] text-white focus:outline-none focus:ring-2 focus:ring-cyan-500"
      oninput="filterSearch()"
    />
  </div>

  <div class="flex flex-wrap gap-2 justify-center mb-6">
    <button onclick="filterRange('A', 'E')" class="bg-cyan-500 hover:bg-cyan-600 px-4 py-2 rounded-full font-semibold">A–E</button>
    <button onclick="filterRange('F', 'K')" class="bg-cyan-500 hover:bg-cyan-600 px-4 py-2 rounded-full font-semibold">F–K</button>
    <button onclick="filterRange('L', 'P')" class="bg-cyan-500 hover:bg-cyan-600 px-4 py-2 rounded-full font-semibold">L–P</button>
    <button onclick="filterRange('Q', 'T')" class="bg-cyan-500 hover:bg-cyan-600 px-4 py-2 rounded-full font-semibold">Q–T</button>
    <button onclick="filterRange('U', 'Z')" class="bg-cyan-500 hover:bg-cyan-600 px-4 py-2 rounded-full font-semibold">U–Z</button>
    <button onclick="resetFilters()" class="bg-cyan-500 hover:bg-cyan-600 px-4 py-2 rounded-full font-semibold">🔁 Reset</button>
  </div>

  <!-- Category Sections -->
  <div class="space-y-8">
    <div class="bg-[#1e1e1e] p-4 rounded-xl shadow" id="nsfwSection">
      <h2 class="text-cyan-400 text-xl border-b border-cyan-500 pb-1 mb-2">🔞 NSFW</h2>
      <div id="nsfwList" class="space-y-2"></div>
    </div>

    <div class="bg-[#1e1e1e] p-4 rounded-xl shadow" id="jestSection">
      <h2 class="text-cyan-400 text-xl border-b border-cyan-500 pb-1 mb-2">🎭 Jest</h2>
      <div id="jestList" class="space-y-2"></div>
    </div>

    <div class="bg-[#1e1e1e] p-4 rounded-xl shadow" id="funSection">
      <h2 class="text-cyan-400 text-xl border-b border-cyan-500 pb-1 mb-2">🎈 Fun</h2>
      <div id="funList" class="space-y-2"></div>
    </div>

    <div class="bg-[#1e1e1e] p-4 rounded-xl shadow" id="theendSection">
      <h2 class="text-cyan-400 text-xl border-b border-cyan-500 pb-1 mb-2">👾 Theend</h2>
      <div id="theendList" class="space-y-2"></div>
    </div>
  </div>

  <!-- Result Overlay -->
  <div id="resultOverlay" class="hidden fixed inset-0 bg-black bg-opacity-70 backdrop-blur-md flex items-center justify-center z-50 p-4">
    <div class="bg-[#1e1e1e] p-6 rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-xl text-center">
      <button onclick="closeResult()" class="mb-4 bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-bold">❌ Close</button>
      <div id="resultContent" class="mb-4"></div>
      <div id="resultActions" class="flex flex-wrap justify-center gap-4"></div>
    </div>
  </div>

  <script>
    const apiKey = localStorage.getItem("mxapi_apikey");
    const allCategories = { nsfw: [], jest: [], fun: [], theend: [] };
    let currentCategory = '', currentType = '', currentIndex = 0;

    if (!apiKey) {
      alert(`⚠️ Your API Key is missing.

This can happen after a platform update. Please go back to the dashboard, click on the sidebar, scroll down and select "Logout", then log back in.

This action is normal.`);
      throw new Error("API key missing");
    }

    async function fetchCategories(route, listId, type) {
      const res = await fetch(`/${route}?meka=${apiKey}`);
      const data = await res.json();
      allCategories[route] = data.categories;

      const container = document.getElementById(listId);
      container.innerHTML = '';

      if (data.categories.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-400 py-2">API not available yet 😔</p>`;
      } else {
        data.categories.forEach(cat => {
          const btn = document.createElement("button");
          btn.textContent = cat;
          btn.className = "w-full text-left bg-[#2a2a2a] hover:bg-[#383838] px-4 py-2 rounded-lg font-semibold";
          btn.onclick = () => {
            currentIndex = 0;
            fetchResult(`${route}/${cat}`, type, cat);
          };
          container.appendChild(btn);
        });
      }
    }

    async function fetchResult(endpoint, type, catName) {
      currentCategory = catName;
      currentType = type;

      const res = await fetch(`/${endpoint}?meka=${apiKey}`);
      const data = await res.json();

      document.getElementById("resultOverlay").classList.remove("hidden");

      let content = '';
      if (type === 'image') {
        content = `<img src="${data.imageUrl}" alt="Image Result" class="rounded-lg max-w-full mx-auto mb-4">`;
        document.getElementById("resultActions").innerHTML = `
          <a href="${data.imageUrl}" download><button class="bg-cyan-500 hover:bg-cyan-600 px-4 py-2 rounded-lg font-bold">💾 Download</button></a>
          <button id="nextBtn" onclick="showNext()" class="bg-cyan-500 hover:bg-cyan-600 px-4 py-2 rounded-lg font-bold">➡️ Next</button>
        `;
      } else {
        content = `<p class="text-lg">${data.content}</p>`;
        document.getElementById("resultActions").innerHTML = `
          <button id="nextBtn" onclick="showNext()" class="bg-cyan-500 hover:bg-cyan-600 px-4 py-2 rounded-lg font-bold">➡️ Next</button>
        `;
      }

      document.getElementById("resultContent").innerHTML = content;
    }

    async function showNext() {
      const btn = document.getElementById("nextBtn");
      btn.disabled = true;
      btn.textContent = "Nextting...";

      const endpoint = findEndpoint(currentCategory);
      if (!endpoint) return;

      await fetchResult(endpoint, currentType, currentCategory);
      btn.disabled = false;
      btn.textContent = "➡️ Next";
    }

    function findEndpoint(category) {
      for (let type in allCategories) {
        if (allCategories[type].includes(category)) {
          return `${type}/${category}`;
        }
      }
      return null;
    }

    function closeResult() {
      document.getElementById("resultOverlay").classList.add("hidden");
      document.getElementById("resultContent").innerHTML = "";
      document.getElementById("resultActions").innerHTML = "";
    }

    function filterRange(startChar, endChar) {
      for (let type in allCategories) {
        const list = document.getElementById(type + 'List');
        list.innerHTML = '';
        let found = false;

        allCategories[type].forEach(cat => {
          const first = cat[0].toUpperCase();
          if (first >= startChar && first <= endChar) {
            const btn = document.createElement("button");
            btn.textContent = cat;
            btn.className = "w-full text-left bg-[#2a2a2a] hover:bg-[#383838] px-4 py-2 rounded-lg font-semibold";
            btn.onclick = () => fetchResult(`${type}/${cat}`, type === 'fun' || type === 'theend' ? 'text' : 'image', cat);
            list.appendChild(btn);
            found = true;
          }
        });

        if (!found) {
          list.innerHTML = `<p class="text-center text-gray-400 py-2">API not available yet 😔</p>`;
        }
      }
    }

    function resetFilters() {
      fetchAll();
      document.getElementById("searchInput").value = "";
    }

    function filterSearch() {
      const keyword = document.getElementById("searchInput").value.toLowerCase();
      for (let type in allCategories) {
        const list = document.getElementById(type + 'List');
        list.innerHTML = '';
        let found = false;

        allCategories[type].forEach(cat => {
          if (cat.toLowerCase().includes(keyword)) {
            const btn = document.createElement("button");
            btn.textContent = cat;
            btn.className = "w-full text-left bg-[#2a2a2a] hover:bg-[#383838] px-4 py-2 rounded-lg font-semibold";
            btn.onclick = () => fetchResult(`${type}/${cat}`, type === 'fun' || type === 'theend' ? 'text' : 'image', cat);
            list.appendChild(btn);
            found = true;
          }
        });

        if (!found) {
          list.innerHTML = `<p class="text-center text-gray-400 py-2">API not available yet 😔</p>`;
        }
      }
    }

    async function fetchAll() {
      await fetchCategories("nsfw", "nsfwList", "image");
      await fetchCategories("jest", "jestList", "image");
      await fetchCategories("fun", "funList", "text");
      await fetchCategories("theend", "theendList", "text");
    }

    fetchAll();
  </script>
</body>
</html>
